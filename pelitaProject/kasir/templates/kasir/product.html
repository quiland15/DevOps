{% extends "base.html" %}
{% load static %}

{% block style %}
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>{{title}}</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
/>
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
  rel="stylesheet"
/>
<link href="{% static 'css/kasir.css' %}" rel="stylesheet">
{% endblock style %}

{% block content %}
<aside class="bg-[#0052CC] w-56 flex flex-col justify-between text-white">
    <div>
      <div class="font-bold text-white text-lg px-6 border-b border-[#0041A8]" style="padding-top:20px; padding-bottom:20px;">
        PELITAKAS
      </div>
      <nav class="mt-6 flex flex-col space-y-1 px-2">
        <a href="{% url 'admindashboard' %}" class="flex items-center space-x-3 px-4 py-2 rounded hover:bg-[#0041A8]">
          <i class="fas fa-th-large text-sm"></i>
          <span class="text-sm">Dashboard</span>
        </a>
        <a href="{% url 'adminKasir' %}" class="flex items-center space-x-3 px-4 py-2 rounded bg-[#0041A8]">
          <i class="fas fa-cash-register text-sm"></i>
          <span class="text-sm">Kasir</span>
        </a>
        <a href="#" aria-current="page" class="flex items-center space-x-3 px-4 py-2 rounded hover:bg-[#0041A8] font-semibold">
          <i class="fas fa-box text-sm"></i>
          <span class="text-sm">Produk</span>
        </a>
        <a href="#" class="flex items-center space-x-3 px-4 py-2 rounded hover:bg-[#0041A8]">
          <i class="fas fa-file-alt text-sm"></i>
          <span class="text-sm">Laporan</span>
        </a>
        <a href="#" class="flex items-center space-x-3 px-4 py-2 rounded hover:bg-[#0041A8]">
          <i class="fas fa-users text-sm"></i>
          <span class="text-sm">Pelanggan</span>
        </a>
        <a href="#" class="flex items-center space-x-3 px-4 py-2 rounded hover:bg-[#0041A8]">
          <i class="fas fa-cog text-sm"></i>
          <span class="text-sm">Pengaturan</span>
        </a>
      </nav>
    </div>
    <a href="{% url 'login' %}" class="px-6 py-3 border-t border-[#0041A8] flex items-center space-x-2 text-sm cursor-pointer hover:bg-[#0041A8]">
      <i class="fas fa-sign-out-alt"></i>
      <span>Keluar</span>
    </a>
  </aside>

  <!-- Main content -->
  <div class="flex-1 flex flex-col">
    <!-- Top bar -->
    <header class="flex items-center justify-between border-b border-[#E6E6E6] bg-white px-6 h-12">
      <div class="text-sm font-normal text-[#1E1E1E]">Produk</div>
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 rounded-full bg-[#0052CC] flex items-center justify-center text-white font-semibold text-xs select-none">
          AT
        </div>
        <span class="text-xs text-[#1E1E1E] font-normal">Admin Tani</span>
      </div>
    </header>

    <!-- Content -->
    <main class="flex-1 overflow-auto p-6 bg-[#F8FCFC]">
      <section>
        <h2 class="font-semibold text-[#1E1E1E] text-base mb-3">Manajemen Produk</h2>
        <div class="mb-6 flex space-x-2">
          <button id="btn-semua" class="text-xs font-normal bg-white border border-[#D1D5DB] rounded px-3 py-1 text-[#1E1E1E]">
            Semua Produk
          </button>
          <button id="btn-stok" class="text-xs font-normal bg-[#E6E6E6] rounded px-3 py-1 text-[#9CA3AF]">
            Stok Menipis
          </button>
        </div>

        <div class="bg-white rounded border border-[#E6E6E6] p-5">
          <h3 class="font-semibold text-[#1E1E1E] text-sm mb-1">Daftar Produk</h3>
          <p class="text-xs text-[#9CA3AF] mb-4">Kelola semua produk yang tersedia di toko anda</p>

          <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-3 mb-4">
            <div class="flex-1 mb-3 sm:mb-0">
              <input
                id="searchInput"
                type="text"
                placeholder="Cari produk.."
                class="w-full border border-[#D1D5DB] rounded px-3 py-2 text-xs text-[#6B7280] focus:outline-none focus:ring-1 focus:ring-[#0052CC]"
              />
            </div>
            <select
              id="categoryFilter"
              class="border border-[#D1D5DB] rounded text-xs text-[#6B7280] px-3 py-2 mb-3 sm:mb-0 focus:outline-none focus:ring-1 focus:ring-[#0052CC]"
              aria-label="Filter kategori"
            >
              <option value="all">Semua Kategori</option>
              <option value="Pertanian">Pertanian</option>
              <option value="Peternakan">Peternakan</option>
            </select>
            <button
              id="btnTambahProduk"
              class="bg-[#0052CC] text-white text-xs font-semibold rounded px-4 py-2 hover:bg-[#003D99] transition-colors"
              type="button"
            >
              + Tambah Produk
            </button>
          </div>

          <div class="overflow-x-auto">
            <table id="productTable" class="w-full text-xs text-left text-[#1E1E1E] border-collapse border border-[#E6E6E6]">
              <thead class="bg-[#F8FCFC] border-b border-[#E6E6E6]">
                <tr>
                  <th class="py-2 px-3 border-r border-[#E6E6E6] font-semibold">Produk</th>
                  <th class="py-2 px-3 border-r border-[#E6E6E6] font-semibold">Kategori</th>
                  <th class="py-2 px-3 border-r border-[#E6E6E6] font-semibold">Harga</th>
                  <th class="py-2 px-3 border-r border-[#E6E6E6] font-semibold">Stok</th>
                  <th class="py-2 px-3 font-semibold">Aksi</th>
                </tr>
              </thead>
              <tbody id="productBody">
                <!-- Rows inserted by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- Modal backdrop -->
<div id="modalBackdrop" class="fixed inset-0 bg-black bg-opacity-30 hidden z-50 flex items-center justify-center">
  <!-- Modal -->
  <div class="bg-white rounded shadow-lg w-full max-w-md mx-4">
    <div class="flex justify-between items-center border-b border-[#E6E6E6] px-6 py-3">
      <h3 id="modalTitle" class="text-sm font-semibold text-[#1E1E1E]">Tambah Produk</h3>
      <button id="closeModal" class="text-[#6B7280] hover:text-[#1E1E1E]" aria-label="Close modal">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="addProductForm" class="px-6 py-4 space-y-4 text-xs text-[#1E1E1E]">
      <div>
        <label for="productName" class="block mb-1 font-semibold">Nama Produk</label>
        <input
          type="text"
          id="productName"
          name="productName"
          required
          class="w-full border border-[#D1D5DB] rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#0052CC]"
          placeholder="Masukkan nama produk"
        />
      </div>
      <div>
        <label for="category" class="block mb-1 font-semibold">Kategori</label>
        <select
          id="category"
          name="category"
          required
          class="w-full border border-[#D1D5DB] rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#0052CC]"
        >
          <option value="" disabled selected>Pilih kategori</option>
          <option value="Pertanian">Pertanian</option>
          <option value="Peternakan">Peternakan</option>
        </select>
      </div>
      <div>
        <label for="price" class="block mb-1 font-semibold">Harga</label>
        <input
          type="text"
          id="price"
          name="price"
          required
          placeholder="Rp 0"
          class="w-full border border-[#D1D5DB] rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#0052CC]"
        />
      </div>
      <div>
        <label for="stock" class="block mb-1 font-semibold">Jumlah Stok</label>
        <input
          type="number"
          id="stock"
          name="stock"
          min="0"
          required
          class="w-full border border-[#D1D5DB] rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#0052CC]"
          placeholder="Masukkan jumlah stok"
        />
      </div>
      <div>
        <label for="expiryDate" class="block mb-1 font-semibold">Tanggal Kadaluarsa</label>
        <input
          type="date"
          id="expiryDate"
          name="expiryDate"
          required
          class="w-full border border-[#D1D5DB] rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[#0052CC]"
        />
      </div>
      <div class="flex justify-end space-x-3 pt-2 border-t border-[#E6E6E6]">
        <button
          type="button"
          id="cancelBtn"
          class="text-[#6B7280] text-xs font-semibold px-4 py-2 rounded hover:bg-[#F3F4F6]"
        >
          Batal
        </button>
        <button
          type="submit"
          class="bg-[#0052CC] text-white text-xs font-semibold rounded px-4 py-2 hover:bg-[#003D99] transition-colors"
        >
          Simpan
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let products = [
    {
      name: "Pupuk NPK",
      category: "Pertanian",
      price: "Rp 85,000",
      stock: 15,
      popular: true,
      expiryDate: "2024-12-31",
    },
    {
      name: "Bibit Jagung Hibrida",
      category: "Pertanian",
      price: "Rp 45,000",
      stock: 100,
      popular: true,
      expiryDate: "2025-01-15",
    },
    {
      name: "Pestisida Organik",
      category: "Pertanian",
      price: "Rp 65,000",
      stock: 30,
      popular: false,
      expiryDate: "2024-11-20",
    },
    {
      name: "Pakan Ternak Ayam",
      category: "Peternakan",
      price: "Rp 75,000",
      stock: 40,
      popular: true,
      expiryDate: "2024-10-10",
    },
    {
      name: "Obat Ternak",
      category: "Peternakan",
      price: "Rp 120,000",
      stock: 25,
      popular: false,
      expiryDate: "2025-02-28",
    },
    {
      name: "Vitamin Ternak",
      category: "Peternakan",
      price: "Rp 50,000",
      stock: 10,
      popular: false,
      expiryDate: "2024-09-15",
    },
    {
      name: "Pupuk Organik Cair",
      category: "Pertanian",
      price: "Rp 55,000",
      stock: 8,
      popular: false,
      expiryDate: "2024-08-30",
    },
    {
      name: "Obat Cacing",
      category: "Peternakan",
      price: "Rp 30,000",
      stock: 5,
      popular: false,
      expiryDate: "2024-07-20",
    }
  ];

  const productBody = document.getElementById("productBody");
  const btnSemua = document.getElementById("btn-semua");
  const btnStok = document.getElementById("btn-stok");
  const searchInput = document.getElementById("searchInput");
  const categoryFilter = document.getElementById("categoryFilter");
  const btnTambahProduk = document.getElementById("btnTambahProduk");
  const modalBackdrop = document.getElementById("modalBackdrop");
  const closeModalBtn = document.getElementById("closeModal");
  const cancelBtn = document.getElementById("cancelBtn");
  const addProductForm = document.getElementById("addProductForm");
  const modalTitle = document.getElementById("modalTitle");

  let editIndex = null; // null means add mode, otherwise edit mode

  // Render products based on filter and search
  function renderProducts(filter = "all") {
    const searchTerm = searchInput.value.toLowerCase();
    const categoryTerm = categoryFilter.value;

    let filteredProducts = products;

    // Filter by stock menipis if needed
    if (filter === "stok") {
      filteredProducts = filteredProducts.filter((p) => p.stock <= 10);
    }

    // Filter by category if not all
    if (categoryTerm !== "all") {
      filteredProducts = filteredProducts.filter((p) => p.category === categoryTerm);
    }

    // Filter by search term
    if (searchTerm) {
      filteredProducts = filteredProducts.filter((p) =>
        p.name.toLowerCase().includes(searchTerm)
      );
    }

    productBody.innerHTML = "";

    if (filteredProducts.length === 0) {
      productBody.innerHTML = `<tr><td colspan="5" class="py-4 px-3 text-center text-[#6B7280]">Tidak ada produk ditemukan</td></tr>`;
      return;
    }

    filteredProducts.forEach((product, idx) => {
      const tr = document.createElement("tr");
      tr.className = "border-t border-[#E6E6E6]";

      // Produk cell with popular badge if any
      const popularBadge = product.popular
        ? `<span class="ml-2 text-[10px] font-semibold text-[#B45309] bg-[#FEF3C7] rounded px-1.5 py-0.5 select-none">Popular</span>`
        : "";

      tr.innerHTML = `
        <td class="py-2 px-3 border-r border-[#E6E6E6] font-semibold">
          ${product.name} ${popularBadge}
        </td>
        <td class="py-2 px-3 border-r border-[#E6E6E6] text-[#6B7280]">${product.category}</td>
        <td class="py-2 px-3 border-r border-[#E6E6E6]">${product.price}</td>
        <td class="py-2 px-3 border-r border-[#E6E6E6]">${product.stock}</td>
        <td class="py-2 px-3 flex space-x-2 text-[#6B7280]">
          <button aria-label="Naikkan stok" class="hover:text-[#0052CC]" data-action="up" data-index="${idx}">
            <i class="fas fa-arrow-up"></i>
          </button>
          <button aria-label="Turunkan stok" class="hover:text-[#0052CC]" data-action="down" data-index="${idx}">
            <i class="fas fa-arrow-down"></i>
          </button>
          <button aria-label="Edit produk" class="hover:text-[#0052CC]" data-action="edit" data-index="${idx}">
            <i class="fas fa-edit"></i>
          </button>
          <button aria-label="Hapus produk" class="text-[#EF4444] hover:text-[#B91C1C]" data-action="delete" data-index="${idx}">
            <i class="fas fa-trash-alt"></i>
          </button>
        </td>
      `;
      productBody.appendChild(tr);
    });
  }

  // Initial render all products
  renderProducts("all");

  // Button click handlers
  btnSemua.addEventListener("click", () => {
    btnSemua.classList.add("bg-white", "border", "border-[#D1D5DB]", "text-[#1E1E1E]");
    btnSemua.classList.remove("bg-[#E6E6E6]", "text-[#9CA3AF]");
    btnStok.classList.remove("bg-white", "border", "border-[#D1D5DB]", "text-[#1E1E1E]");
    btnStok.classList.add("bg-[#E6E6E6]", "text-[#9CA3AF]");
    renderProducts("all");
  });

  btnStok.addEventListener("click", () => {
    btnStok.classList.add("bg-white", "border", "border-[#D1D5DB]", "text-[#1E1E1E]");
    btnStok.classList.remove("bg-[#E6E6E6]", "text-[#9CA3AF]");
    btnSemua.classList.remove("bg-white", "border", "border-[#D1D5DB]", "text-[#1E1E1E]");
    btnSemua.classList.add("bg-[#E6E6E6]", "text-[#9CA3AF]");
    renderProducts("stok");
  });

  // Search input event
  searchInput.addEventListener("input", () => {
    if (btnSemua.classList.contains("bg-white")) {
      renderProducts("all");
    } else {
      renderProducts("stok");
    }
  });

  // Category filter event
  categoryFilter.addEventListener("change", () => {
    if (btnSemua.classList.contains("bg-white")) {
      renderProducts("all");
    } else {
      renderProducts("stok");
    }
  });

  // Show modal for add or edit
  btnTambahProduk.addEventListener("click", () => {
    editIndex = null;
    modalTitle.textContent = "Tambah Produk";
    addProductForm.reset();
    modalBackdrop.classList.remove("hidden");
  });

  // Close modal
  function closeModal() {
    modalBackdrop.classList.add("hidden");
    editIndex = null;
  }
  closeModalBtn.addEventListener("click", closeModal);
  cancelBtn.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e) => {
    if (e.target === modalBackdrop) closeModal();
  });

  // Add or Edit product form submit
  addProductForm.addEventListener("submit", (e) => {
    e.preventDefault();

    const name = addProductForm.productName.value.trim();
    const category = addProductForm.category.value;
    const price = addProductForm.price.value.trim();
    const stock = parseInt(addProductForm.stock.value, 10);
    const expiryDate = addProductForm.expiryDate.value;

    if (!name || !category || !price || isNaN(stock) || !expiryDate) {
      alert("Mohon isi semua field dengan benar.");
      return;
    }

    if (editIndex === null) {
      // Add new product
      products.push({
        name,
        category,
        price,
        stock,
        popular: false,
        expiryDate,
      });
    } else {
      // Edit existing product
      products[editIndex] = {
        ...products[editIndex],
        name,
        category,
        price,
        stock,
        expiryDate,
      };
    }

    closeModal();

    // Reset filters to show all and clear search
    btnSemua.click();
    searchInput.value = "";
    categoryFilter.value = "all";

    renderProducts("all");
  });

  // Handle action buttons in table (up, down, edit, delete)
  productBody.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;

    const action = btn.getAttribute("data-action");
    const index = parseInt(btn.getAttribute("data-index"), 10);
    if (isNaN(index) || !action) return;

    if (action === "up") {
      // Increase stock by 1
      products[index].stock++;
      renderProducts(btnSemua.classList.contains("bg-white") ? "all" : "stok");
    } else if (action === "down") {
      // Decrease stock by 1 but not below 0
      if (products[index].stock > 0) {
        products[index].stock--;
        renderProducts(btnSemua.classList.contains("bg-white") ? "all" : "stok");
      }
    } else if (action === "edit") {
      // Open modal with product data for editing
      editIndex = index;
      modalTitle.textContent = "Edit Produk";
      const p = products[index];
      addProductForm.productName.value = p.name;
      addProductForm.category.value = p.category;
      addProductForm.price.value = p.price;
      addProductForm.stock.value = p.stock;
      addProductForm.expiryDate.value = p.expiryDate || "";
      modalBackdrop.classList.remove("hidden");
    } else if (action === "delete") {
      // Confirm and delete product
      if (confirm(`Hapus produk "${products[index].name}"?`)) {
        products.splice(index, 1);
        renderProducts(btnSemua.classList.contains("bg-white") ? "all" : "stok");
      }
    }
  });
</script>
{% endblock content %}